@model WikiPage
@Html.TextAreaFor(m => m.Text)

<script type="text/javascript"> // TODO: move to separate file
    $(function () {
        var state = {
            connected: false,
            subscription: null
        };
        var text = $('#Text');

        var unsubscribe = function () {
            if (state.subscription)
                $.cometd.unsubscribe(state.subscription);

            state.subscription = null;
        };

        $.cometd.configure({ url: '@Url.Content("~/comet.axd")' });
        $.cometd.addListener('/meta/connect', function (message) {
            var wasConnected = state.connected;
            state.connected = message.successful;

            if (state.connected && !wasConnected) {
                text.css({ 'border': '1px solid green' }); // TEMPHACK

                unsubscribe();
                state.subscription = $.cometd.subscribe('/wiki/change', function (comet) {
                    if (comet.data.page != '@Model.Slug')
                        return;

                    text.val(comet.data.message);
                });
            }
            else if (wasConnected && !state.connected) {
                text.css({ 'border': '1px solid red' }); // TEMPHACK
                unsubscribe();
            }
        });

        $.cometd.addListener('/meta/disconnect', function (message) {
            if (message.successful) {
                state.connected = false;
                unsubscribe();
            }
        });

        $.cometd.handshake();

        text.keyup($.throttle(1000, function () {
            if (!state.connected)
                return;

            $.cometd.publish('/wiki/change', { 
                page: '@Model.Slug',
                message: text.val()
            });
        }));
    });
</script>